<html>
  <head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type"/>
    <style>
      .imgbox {
          display: grid;
          height: 100%;
      }
      .img {
          min-width: 502px;
          max-width: 100%;
          max-height: 100vh;
          border: 1px solid black;
          margin-right: 10px;
      }
  </style>
  </head>
  <body>
    <div class="imgbox">
      <div>
          <image id="rImg" class="img" />
      </div>
      <div>
          <image id="hImg" class="img" />
      </div>
    </div>
    
    <script type="module">
      import init, { RSDM } from './pkg/really_simple_dispersion_wasm.js';
      
      const LEVELS = 10;

      function drawGrid(grid, target, rows, cols) {
        // Create temporary canvas to build png image
        const canvas = document.createElement('canvas');
        canvas.height = rows;
        canvas.width = cols;

        const ctx = canvas.getContext('2d');
        const imgData = ctx.createImageData(cols, rows);
        
        // Construct an image of the given width and height
        let i = 0;
        for (let y=0; y<rows; y++) {
          for (let x=0; x<cols; x++) {
            // Calculate offset as encoding in repeating blocks of RGBA
            const d = y * cols + x;
            const i = d * 4;
            
            // Default pixel set to white
            let pixelR = 255;
            let pixelG = 255;
            let pixelB = 255;
            
            // Set shade of blue if concentration meets criteria
            if (grid[d] > 0) {
              const conc = grid[d] / LEVELS;
              pixelR = 255 - 255*conc;
              pixelG = 255 - 255*conc;
              pixelB = 255;
            }

            imgData.data[i] = pixelR;
            imgData.data[i+1] = pixelG;
            imgData.data[i+2] = pixelB;
            imgData.data[i+3] = 255;
          }
        }
        ctx.putImageData(imgData, 0, 0);
        document.getElementById(target).src = canvas.toDataURL('image/png');
      }

      async function run() {
        const wasm = await init();
        
        // Setup RSDM
        const rsdm = RSDM.new();
        
        // Run sample model and create image data
        rsdm.iter_disp(1);
        rsdm.update_png();

        const height = rsdm.height();
        const width = rsdm.width();
        const altitude = rsdm.altitude();
        
        // Get pointer to grids in wasm linear memory
        const r_grid = new Uint8Array(wasm.memory.buffer, rsdm.r_grid(), width * height);
        const h_grid = new Uint8Array(wasm.memory.buffer, rsdm.h_grid(), width * altitude);
        //console.log(r_grid);
        
        // Draw images to canvas
        drawGrid(r_grid, "rImg", height, width);
        drawGrid(h_grid, "hImg", altitude, width);
      }

      run();
    </script>
  </body>
</html>